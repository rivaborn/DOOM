# File Overview

**File:** `ipx/IPXSETUP.C`
**Target Platform:** MS-DOS (16-bit real mode, Borland C)

`IPXSETUP.C` is the main program entry point and high-level coordinator for the DOOM IPX network driver. It is the file that contains `main()` and orchestrates the complete lifecycle of a DOOM IPX multiplayer session:

1. Parse command-line arguments (including response files).
2. Initialize the IPX network stack.
3. Run the node-discovery protocol to find all players on the LAN.
4. Assign player numbers.
5. Launch the DOOM executable.
6. Clean up on exit.

It also defines several global variables shared across the driver, the interrupt service routine `NetISR` that DOOM calls during play, and utility functions `Error()` and `CheckParm()`.

---

## Global Variables

| Type | Name | Description |
|------|------|-------------|
| `int` | `gameid` | A session identifier (currently always initialized to `0` in `main()`). Intended to allow multiple concurrent DOOM sessions on the same IPX network segment to coexist without interfering. Broadcast in setup packets via `setupdata_t.gameid`. |
| `int` | `numnetnodes` | The total number of network nodes (computers) expected in this game session. Defaults to `2`, overridden by the `-nodes N` command-line argument. This includes both players and drones. |
| `int` | `socketid` | The IPX socket number used for all DOOM network traffic. Initialized to `0x869C`, the officially assigned DOOM IPX socket number. Can be overridden with the `-port N` argument. |
| `int` | `myargc` | Effective argument count, initially set from `_argc` then potentially expanded by `FindResponseFile()` when a `@responsefile` argument is present. |
| `char **` | `myargv` | Effective argument vector, initially set from `_argv` then potentially replaced by `FindResponseFile()`. |
| `setupdata_t nodesetup[MAXNETNODES]` | `nodesetup` | Per-node setup data received during the discovery phase. Each entry holds the `nodesfound`, `nodeswanted`, `drone`, and `gameid` fields as reported by the corresponding node. |

---

## Functions

### `Error`

**Signature:**
```c
void Error(char *error, ...)
```

**Purpose:**
The centralized error handler for abnormal termination. Restores the interrupt vector if it was hooked, prints a formatted error message, shuts down the network, and exits with code 1.

**Parameters:**
- `error` — `printf`-style format string. If NULL, still performs cleanup.
- `...` — Variadic format arguments.

**Return Value:** Does not return (calls `exit(1)`).

**Key Logic:**
1. If `vectorishooked` is set, calls `setvect(doomcom.intnum, olddoomvect)` to restore the original interrupt vector before exiting.
2. Uses `va_start`/`vprintf`/`va_end` for variadic formatting.
3. Calls `ShutdownNetwork()` to close the IPX socket.

---

### `CheckParm`

**Signature:**
```c
int CheckParm(char *parm)
```

**Purpose:**
Searches the effective argument vector (`myargv`) for the given string using case-insensitive comparison.

**Parameters:**
- `parm` — The command-line parameter string to search for (e.g., `"-nodes"`, `"-port"`).

**Return Value:**
- The 1-based index into `myargv` where `parm` was found.
- `0` if `parm` is not present.

**Key Logic:**
Iterates `myargv[1..myargc-1]` using `stricmp()` (case-insensitive string compare). Returns the index immediately on a match.

---

### `NetISR`

**Signature:**
```c
void interrupt NetISR(void)
```

**Purpose:**
The interrupt service routine installed at `doomcom.intnum`. Called by the DOOM game engine whenever it needs to send or receive a network packet. Dispatches to `SendPacket()` or `GetPacket()` based on `doomcom.command`.

**Parameters:** None (interrupt handler; no parameters).

**Return Value:** `void` (returns via `iret` generated by the `interrupt` keyword).

**Key Logic:**
- If `doomcom.command == CMD_SEND`: increments `localtime` to sequence outgoing packets, then calls `SendPacket(doomcom.remotenode)`.
- If `doomcom.command == CMD_GET`: calls `GetPacket()`, which fills `doomcom.remotenode` and `doomcom.data` with the received packet contents.

---

### `LookForNodes`

**Signature:**
```c
void LookForNodes(void)
```

**Purpose:**
Implements the pre-game node discovery protocol. Broadcasts setup packets every second and processes incoming ones until all expected nodes have been found and each node has confirmed it sees all the others. Then assigns player numbers based on relative IPX node addresses.

**Parameters:** None.

**Return Value:** `void`. Exits via `Error()` if ESC is pressed or if more than `MAXPLAYERS` non-drone players are found.

**Key Logic:**

1. **Setup phase initialization:** Sets `localtime = -1` (setup mode) and initializes `nodesetup[0]` with `nodesfound = 1` and `nodeswanted = numnetnodes`. Sets `doomcom.numnodes = 1`.

2. **Main discovery loop (`do ... while(1)`):**
   - Polls for ESC key via `bioskey(1)` to allow user abort.
   - Calls `GetPacket()` in a loop to process all pending received packets.
     - For each received packet: if `remotetime != -1`, it is a game-phase packet from an already-started session (treat as "found all nodes").
     - If `doomcom.remotenode == -1`, this is a new node: adds its address from `remoteadr` to `nodeadr[doomcom.numnodes]` and increments `doomcom.numnodes`.
     - Copies received `setupdata_t` data into `nodesetup[remotenode]`.
   - Checks termination: if all discovered nodes report `nodesfound == nodeswanted`, the loop breaks.
   - Every second (detected via `gettime()` comparing `ti_sec` to `oldsec`): sends a broadcast packet containing the local `nodesetup[0]` data to `MAXNETNODES` (broadcast).

3. **Player number assignment:** Iterates all nodes, counting non-drone players. Counts how many nodes have a lower IPX address than the local node — this count becomes `doomcom.consoleplayer` (so player numbers are deterministically assigned by MAC address ordering). Sets `doomcom.numplayers` to the total non-drone count.

---

### `FindResponseFile`

**Signature:**
```c
void FindResponseFile(void)
```

**Purpose:**
Scans `myargv` for an argument beginning with `@`. If found, reads the named file, parses it as whitespace-separated tokens, replaces `myargv` with the combined contents (file tokens plus any arguments that followed the `@arg`), and updates `myargc` accordingly.

**Parameters:** None.

**Return Value:** `void`. Calls `Error()` if the response file cannot be opened.

**Key Logic:**
- Opens the file in binary mode, reads its entire contents into a heap buffer.
- Saves any arguments that followed the `@filename` argument in `moreargs[]`.
- Allocates a new `myargv` array (up to `MAXARGVS = 100` entries).
- Parses the file buffer by scanning for printable non-space tokens (characters `' '+1` through `'z'`), null-terminating each in-place. Non-printable or out-of-range characters act as delimiters.
- Appends the saved `moreargs` at the end of the new `myargv`.

---

### `main`

**Signature:**
```c
void main(void)
```

**Purpose:**
Entry point for the IPXSETUP driver. Parses command-line arguments, initializes the IPX network, runs node discovery, and launches DOOM.

**Return Value:** Exits with code 0 on success.

**Key Logic — Execution sequence:**

1. Set default game parameters (`ticdup=1`, `extratics=1`, `episode=1`, `map=1`, `skill=2`, `deathmatch=0`, `numnetnodes=2`).
2. Print the driver banner (DOOM or DOOM II variant via conditional compilation on `DOOM2`).
3. Copy `_argc`/`_argv` into `myargc`/`myargv` and call `FindResponseFile()`.
4. Process `-nodes N`: override `numnetnodes`.
5. Process `-vector 0xNN`: use a specific interrupt vector. Validates the vector slot is NULL or points to an `iret` (0xCF) instruction. If not specified, scans 0x60..0x66 for a free slot.
6. Print the chosen communication vector.
7. Process `-port N`: override `socketid`.
8. Call `InitNetwork()` to initialize IPX.
9. Call `LookForNodes()` to run discovery and assign player numbers.
10. Set `localtime = 0` (switch from setup mode to game mode).
11. Call `LaunchDOOM()` to spawn the DOOM executable and wait for it to exit.
12. Call `ShutdownNetwork()` and restore the interrupt vector.
13. Exit with code 0.

**Command-line arguments processed:**

| Argument | Description |
|----------|-------------|
| `-nodes N` | Set the expected number of network nodes (default: 2) |
| `-vector 0xNN` | Force use of a specific interrupt vector (0x60..0x66 range expected) |
| `-port N` | Override the IPX socket number (default: 0x869C) |
| `@filename` | Read additional arguments from a response file |

---

## Data Structures

This file uses `setupdata_t` (defined in `ipxnet.h`) as a local array `nodesetup[MAXNETNODES]`.

---

## Dependencies

| File | Reason |
|------|--------|
| `<conio.h>` | `bioskey` for keyboard polling |
| `<stdio.h>` | `printf`, `vprintf`, `sscanf`, `sprintf` |
| `<stdlib.h>` | `atoi`, `exit`, `malloc` |
| `<dos.h>` | `getvect`, `setvect`, `gettime`, interrupt vector manipulation |
| `<string.h>` | `memcpy`, `memcmp`, `stricmp` |
| `<process.h>` | `_argc`, `_argv` |
| `<stdarg.h>` | `va_list`, `va_start`, `va_end` for variadic `Error()` |
| `<bios.h>` | `bioskey` |
| `ipxnet.h` | `setupdata_t`, `nodeadr`, `remoteadr`, `localadr`, `localtime`, `remotetime`, `NUMPACKETS`, all IPX types |
| `ipx_frch.h` (or `ipxstr.h`) | Localized string constants (`STR_ATTEMPT`, `STR_LOOKING`, `STR_FOUND`, etc.) |
| `DOOMNET.C` | Provides `doomcom`, `vectorishooked`, `olddoomvect`, `LaunchDOOM()` |
| `IPXNET.C` | Provides `InitNetwork()`, `ShutdownNetwork()`, `SendPacket()`, `GetPacket()` |
